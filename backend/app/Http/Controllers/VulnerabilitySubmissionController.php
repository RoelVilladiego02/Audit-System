<?php

namespace App\Http\Controllers;

use App\Models\VulnerabilitySubmission;
use App\Models\Vulnerability;
use App\Models\Department;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;

class VulnerabilitySubmissionController extends Controller
{
    public function index(Request $request): JsonResponse
    {
        $query = VulnerabilitySubmission::with(['user', 'department', 'vulnerabilities']);
        
        // If user is not admin, only show their own submissions
        if (!$request->user()->isAdmin()) {
            $query->where('user_id', $request->user()->id);
        }
        
        // Apply filters
        if ($request->has('department_id')) {
            $query->where('department_id', $request->department_id);
        }
        
        if ($request->has('risk_level')) {
            $query->where('risk_level', $request->risk_level);
        }
        
        if ($request->has('is_resolved')) {
            $query->where('is_resolved', $request->boolean('is_resolved'));
        }
        
        $submissions = $query->orderBy('created_at', 'desc')
                           ->paginate($request->get('per_page', 15));
        
        return response()->json($submissions);
    }

    public function store(Request $request): JsonResponse
    {
        $validated = $request->validate([
            'department_id' => 'required|exists:departments,id',
            'title' => 'required|string|max:255',
            'description' => 'required|string',
            'vulnerabilities' => 'required|array|min:1',
            'vulnerabilities.*.category' => 'required|string|max:255',
            'vulnerabilities.*.title' => 'required|string|max:255',
            'vulnerabilities.*.description' => 'required|string',
            'vulnerabilities.*.severity' => 'required|in:low,medium,high',
            'vulnerabilities.*.cvss_score' => 'nullable|numeric|min:0|max:10',
            'vulnerabilities.*.affected_systems' => 'nullable|array',
            'vulnerabilities.*.remediation_steps' => 'nullable|string',
        ]);

        return DB::transaction(function () use ($validated, $request) {
            // Calculate overall risk based on vulnerabilities
            $vulnerabilities = $validated['vulnerabilities'];
            $riskScore = $this->calculateRiskScore($vulnerabilities);
            $riskLevel = $this->determineRiskLevel($riskScore);

            // Create submission
            $submission = VulnerabilitySubmission::create([
                'user_id' => $request->user()->id,
                'department_id' => $validated['department_id'],
                'title' => $validated['title'],
                'description' => $validated['description'],
                'risk_score' => $riskScore,
                'risk_level' => $riskLevel,
                'status' => 'open',
            ]);

            // Create vulnerabilities
            foreach ($vulnerabilities as $vulnData) {
                Vulnerability::create([
                    'vulnerability_submission_id' => $submission->id,
                    'category' => $vulnData['category'],
                    'title' => $vulnData['title'],
                    'description' => $vulnData['description'],
                    'severity' => $vulnData['severity'],
                    'cvss_score' => $vulnData['cvss_score'] ?? null,
                    'affected_systems' => $vulnData['affected_systems'] ?? [],
                    'remediation_steps' => $vulnData['remediation_steps'] ?? null,
                    'is_resolved' => false,
                ]);
            }

            return response()->json([
                'submission' => $submission->load(['vulnerabilities', 'department']),
                'message' => 'Vulnerability submission created successfully'
            ], 201);
        });
    }

    public function show(VulnerabilitySubmission $submission): JsonResponse
    {
        // Check if the user owns this submission or is an admin
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        return response()->json($submission->load(['user', 'department', 'vulnerabilities']));
    }

    public function update(Request $request, VulnerabilitySubmission $submission): JsonResponse
    {
        // Check permissions
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $validated = $request->validate([
            'title' => 'sometimes|string|max:255',
            'description' => 'sometimes|string',
            'status' => 'sometimes|in:open,in_progress,resolved,closed',
            'assigned_to' => 'sometimes|exists:users,id',
            'resolution_notes' => 'sometimes|string',
            'risk_level' => 'sometimes|in:low,medium,high',
            'risk_score' => 'sometimes|numeric|min:0|max:100',
        ]);

        $submission->update($validated);

        // If status is being set to resolved, update resolved_at
        if (isset($validated['status']) && $validated['status'] === 'resolved') {
            $validated['resolved_at'] = now();
            $submission->vulnerabilities()->where('is_resolved', false)->each(function($vulnerability) {
                $vulnerability->markResolved(auth()->user());
            });
        }

        return response()->json([
            'submission' => $submission->load(['vulnerabilities', 'department']),
            'message' => 'Submission updated successfully'
        ]);
    }

    public function destroy(VulnerabilitySubmission $submission): JsonResponse
    {
        // Check permissions
        if ($submission->user_id !== auth()->id() && !auth()->user()->isAdmin()) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $submission->delete();
        return response()->json(['message' => 'Submission deleted successfully']);
    }

    private function calculateRiskScore(array $vulnerabilities): float
    {
        $totalScore = 0;
        $severityWeights = ['low' => 1, 'medium' => 2, 'high' => 3];

        foreach ($vulnerabilities as $vuln) {
            $totalScore += $severityWeights[$vuln['severity']];
        }

        // Normalize to 0-10 scale based on number of vulnerabilities
        $maxPossibleScore = count($vulnerabilities) * 3;
        return round(($totalScore / $maxPossibleScore) * 10, 2);
    }

    private function determineRiskLevel(float $riskScore): string
    {
        if ($riskScore >= 7) return 'high';
        if ($riskScore >= 4) return 'medium';
        return 'low';
    }
}
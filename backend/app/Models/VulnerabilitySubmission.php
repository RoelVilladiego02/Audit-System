<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class VulnerabilitySubmission extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'department_id',
        'title',                  // Add title for better identification
        'description',            // Overall description of the submission
        'risk_score',
        'risk_level',
        'status',                 // open, in_progress, resolved, closed
        'assigned_to',            // Admin assigned to handle this
        'resolved_at',
        'resolution_notes',
    ];

    protected $casts = [
        'resolved_at' => 'datetime',
    ];

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    public function vulnerabilities()
    {
        return $this->hasMany(Vulnerability::class);
    }

    public function assignedTo()
    {
        return $this->belongsTo(User::class, 'assigned_to');
    }

    // Check if all vulnerabilities are resolved
    public function isFullyResolved(): bool
    {
        return $this->vulnerabilities()->where('is_resolved', false)->count() === 0;
    }

    // Get highest severity from all vulnerabilities
    public function getHighestSeverityAttribute(): string
    {
        $severities = ['low' => 1, 'medium' => 2, 'high' => 3];
        $highest = $this->vulnerabilities()
            ->pluck('severity')
            ->map(fn($s) => $severities[$s] ?? 1)
            ->max();

        return array_search($highest, $severities) ?: 'low';
    }

    // Calculate overall risk score from vulnerabilities
    public function calculateRiskScore(): int
    {
        $vulnerabilities = $this->vulnerabilities;
        if ($vulnerabilities->isEmpty()) return 0;

        $severityScores = ['low' => 1, 'medium' => 3, 'high' => 7];
        $totalScore = $vulnerabilities->sum(function($vuln) use ($severityScores) {
            return $severityScores[$vuln->severity] ?? 1;
        });

        return min($totalScore, 100); // Cap at 100
    }

    // Scopes
    public function scopeOpen($query)
    {
        return $query->whereIn('status', ['open', 'in_progress']);
    }

    public function scopeResolved($query)
    {
        return $query->where('status', 'resolved');
    }

    public function scopeHighPriority($query)
    {
        return $query->where('risk_level', 'high')->orWhere('risk_score', '>=', 70);
    }
}